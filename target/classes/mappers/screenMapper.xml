<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
 <mapper namespace="com.oldtom.smartstock.mapper.ScreenMapper">
 	
 	<select id="getResults" resultType="StockVO">
 	<![CDATA[
 	select date, shcode, hname, price, dy_rate, ict_rate, uprate, downrate, avg_price
 	from amartall
 	where date = #{date}
 	order by shcode asc
 	limit 0, 10
 	]]>
 	</select>
 
  	<select id="screen1" resultType="StockVO">
 	<![CDATA[
	select a.date, a.shcode, a.hname, a.total, b.close price, b.volume, (b.close-c.low)/c.low*100 rate
	from
	 (select * from ssummary where date = #{basedate}) a,
	 (select * from dchart where date = #{basedate}) b,
	 (select shcode, min(low) low from dchart
	  where date between (select date from jonghap where date <= #{basedate} order by date desc limit #{duration}, 1) 
	    and #{basedate}
	  group by shcode
	 ) c
	where a.shcode = b.shcode and b.shcode = c.shcode and (b.close-c.low)/c.low*100 <= #{rate}
 	]]>
 	</select>
 
  	<select id="screen2" resultType="StockVO">
 	<![CDATA[
	select a.date, a.shcode, a.hname, a.total, b.close price, b.volume, (c.high-b.close)/c.high*100 rate
	from
	 (select * from ssummary where date = #{basedate}) a,
	 (select * from dchart where date = #{basedate}) b,
	 (select shcode, max(high) high from dchart
	  where date between (select date from jonghap where date <= #{basedate} order by date desc limit #{duration}, 1)
	  and #{basedate}
	  group by shcode
	 ) c
	where a.shcode = b.shcode and b.shcode = c.shcode and (c.high-b.close)/c.high*100 >= #{rate}
 	]]>
 	</select>

  	<select id="screen3" resultType="StockVO">
 	<![CDATA[
	select a.shcode, a.hname, a.total, b.close price, b.volume, c.rate
	from
	 (select * from ssummary where date = #{basedate}) a,
	 (select * from dchart where date = #{basedate}) b,
	 (select * from shareholder where holder= #{holder} and rate >= #{rate}) c
	where a.shcode = b.shcode and b.shcode = c.shcode
 	]]>
 	</select>
 
   	<select id="screen4" resultType="StockVO">
 	<![CDATA[
	select a.shcode, a.hname, a.total, b.close price, b.volume, (c.gmvolume-d.gmvolume)/d.gmvolume*100 rate
	from
	 (select * from ssummary where date = #{basedate}) a,
	    (select * from dchart where date = #{basedate}) b,
	 (select * from lender where date='20171117' and gmvolume >0 ) c,
	 (select * from lender 
	  where date=(select date from lender where date < #{basedate} order by date desc limit 1)) d
	where a.shcode=b.shcode and b.shcode=c.shcode and c.shcode = d.shcode 
	 and (c.gmvolume-d.gmvolume)/d.gmvolume*100 >= #{rate}
 	]]>
 	</select>
 
   	<select id="screen5" resultType="StockVO">
 	<![CDATA[
	select a.shcode, a.hname, a.total, b.close price, b.volume, (c.sybalance -d.sybalance)/d.sybalance *100 rate
	from
	 (select * from ssummary where date = #{basedate}) a,
	    (select * from dchart where date = #{basedate}) b,
	 (select * from lender where date=#{basedate} and sybalance >0 ) c,
	 (select * from lender 
	  where date=(select date from lender where date < #{basedate} order by date desc limit 1)) d
	where a.shcode=b.shcode and b.shcode=c.shcode and c.shcode = d.shcode 
	 and (c.sybalance -d.sybalance)/d.sybalance *100 >= #{rate}
 	]]>
 	</select>
 	
 	<select id="screen6" resultType="StockVO">
 	<![CDATA[
	select a.shcode, a.hname, a.total, b.close price, b.volume, round((base-min)/base*100,1) rate, 
		round((max-base)/base*100,1) downrate
	from
	 (select * from ssummary where date = #{basedate}) a,
	 (select * from dchart where date = #{basedate}) b,
	 (select shcode, min(low) min, max(high) max, avg(close) base from dstock
	  where date between (select date from jonghap where date <= #{basedate} order by date desc limit #{duration}, 1)
	  and #{basedate}
	     group by shcode
	 ) c
	where a.shcode = b.shcode and b.shcode = c.shcode and (base-min)/base*100 <= #{rate} and (max-base)/base*100 <= #{rate}
	order by a.total desc
 	]]>
 	</select>
 		
   	<select id="screen7" resultType="StockVO">
 	<![CDATA[
	select a.date, a.shcode, a.hname, a.total, b.close price, b.volume, a.dy_rate, a.rate
	from
 		(select * from ssummary where date = #{basedate}) a,
    	(select * from dchart where date = #{basedate}) b,
	 	(select shcode, count(fpvolume) cnt from dstock
	  	 where date between (select date from jonghap a where date <= #{basedate} order by date desc limit #{duration}, 1)
	  		and #{basedate} and fpvolume > 0
	     group by shcode
	     having cnt = #{duration}+1
	 	) c
	where a.shcode = b.shcode and b.shcode = c.shcode
 	]]>
 	</select>
 		 		
  	<select id="procedure" resultType="StockVO" statementType="CALLABLE">
 	<![CDATA[
 	{call screen5(#{basedate}, #{duration}, #{total}, #{ic_rate}, #{dy_rate})}
 	]]>
 	</select>
 	 			
 </mapper>